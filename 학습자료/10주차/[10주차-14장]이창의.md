### í•™ìŠµ ë‚´ìš©

- ì»¬ë ‰ì…˜ : ë‹¤ì–‘í•œ ì»¬ë ‰ì…˜ê³¼ íŠ¹ì§•ì„ ì„¤ëª…í•œë‹¤.
- ì»¨ë²„í„° : ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ ë³€í™˜í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œë‹¤.
- ë¦¬ìŠ¤ë„ˆ : ì—”í‹°í‹°ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•œë‹¤.
- ì—”í‹°í‹° ê·¸ë˜í”„ : ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ ì„ íƒí•´ì„œ í•¨ê»˜ ì¡°íšŒí•œë‹¤.

# 14.1 ì»¬ë ‰ì…˜

> JPAëŠ” ìë°”ì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” Collection, List, Map ì»¬ë ‰ì…˜ì„ ì§€ì›í•˜ê³  ë‹¤ìŒ ê²½ìš°ì— ì´ ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
> 
- OneToMany, @ManyToManyë¥¼ ì‚¬ìš©í•´ì„œ ì¼ëŒ€ë‹¤ë‚˜ ë‹¤ëŒ€ë‹¤ ì—”í‹°í‹° ê´€ê³„ë¥¼ ë§¤í•‘í•  ë•Œ
- @ElementCollectionì„ ì‚¬ìš©í•´ì„œ ê°’ íƒ€ì…ì„ í•˜ë‚˜ ì´ìƒ ë³´ê´€í•  ë•Œ



### ìë°” ì»¬ë ‰ì…˜ì˜ íŠ¹ì§•

- Collection : ìë°”ê°€ ì œê³µí•˜ëŠ” ìµœìƒìœ„ ì»¬ë ‰ì…˜ì´ë‹¤.
    - í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì¤‘ë³µì„ í—ˆìš©í•˜ê³  ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  ê°€ì •í•œë‹¤.
- Set : ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì»¬ë ‰ì…˜ì´ë‹¤.
    - ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
- List : ìˆœì„œê°€ ìˆëŠ” ì»¬ë ‰ì…˜ì´ë‹¤.
    - ìˆœì„œë¥¼ ë³´ì¥í•˜ê³  ì¤‘ë³µì„ í—ˆìš©í•œë‹¤.
- Map : Key, Value êµ¬ì¡°ë¡œ ë˜ì–´ ìˆëŠ” íŠ¹ìˆ˜í•œ ì»¬ë ‰ì…˜ì´ë‹¤.

JPA ëª…ì„¸ì—ëŠ” ìë°” ì»¬ë ‰ì…˜ ì¸í„°í˜ì´ìŠ¤ì— ëŒ€í•œ íŠ¹ë³„í•œ ì–¸ê¸‰ì´ ì—†ë‹¤.

- ë”°ë¼ì„œ JPA êµ¬í˜„ì²´ì— ë”°ë¼ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì´ ì¡°ê¸ˆì”© ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì„œëŠ” í•˜ì´ë²„ë„¤ì´íŠ¸ êµ¬í˜„ì²´ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.

<aside>
ğŸ¤š Mapì€ ë³µì¡í•œ ë§¤í•‘ì— ë¹„í•´ í™œìš©ë„ê°€ ë–¨ì–´ì§€ê³  ë‹¤ë¥¸ ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•´ë„ ì¶©ë¶„í•˜ë¯€ë¡œ ìƒëµí–ˆë‹¤. ì°¸ê³ ë¡œ Mapì€ @MapKey ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë§¤í•‘í•  ìˆ˜ ìˆë‹¤.

</aside>

## 14.1.1 JPAì™€ ì»¬ë ‰ì…˜

í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì»¬ë ‰ì…˜ í•„ë“œë¥¼ í•˜ì´ë²„ë„¤ì´íŠ¸ì—ì„œ ì¤€ë¹„í•œ ì»¬ë ‰ì…˜ìœ¼ë¡œ ê°ì‹¸ì„œ ì‚¬ìš©í•œë‹¤.

```java
@Entity
public class Team{
		@Id
		private String id;
		
		@OneToMany
		@JoinColumn
		private Collection<Member> members = new ArrayList<Member>();
}
```

Teamì€ members ì»¬ë ‰ì…˜ì„ í•„ë“œë¡œ ê°€ì§€ê³  ìˆë‹¤. ë‹¤ìŒ ì½”ë“œë¡œ Teamì„ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ì–´ë³´ì.

```java
Team team = new Team();

System.out.println("before persist = "+ team.getMembers().getClass());
em.persist(team);
System.out.println("after persist = " + team.getMembers().getClass());

// ê²°ê³¼
before persist = class java.util.ArrayList
after persist = class org.hibernate.collection.internal.PersistentBag
```

ì¶œë ¥ ê²°ê³¼ë¥¼ ë³´ë©´ ì›ë˜ ArrayList íƒ€ì…ì´ì—ˆë˜ ì»¬ë ‰ì…˜ì´ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“  ì§í›„ì— í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì œê³µí•˜ëŠ” PersistentBag íƒ€ì…ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆë‹¤.

í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì»¬ë ‰ì…˜ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì›ë³¸ ì»¬ë ‰ì…˜ì„ ê°ì‹¸ê³  ìˆëŠ” ë‚´ì¥ ì»¬ë ‰ì…˜ì„ ìƒì„±í•´ì„œ ì´ ë‚´ì¥ ì»¬ë ‰ì…˜ì„ ì´ìš©í•˜ë„ë¡ ì°¸ì¡°ë¥¼ ë³€ê²½í•œë‹¤.

- í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ì œê³µí•˜ëŠ” ë‚´ì¥ ì»¬ë ‰ì…˜ì€ ì›ë³¸ ì»¬ë ‰ì…˜ì„ ê°ì‚¬ê³  ìˆì–´ì„œ ë˜í¼ ì»¬ë ‰ì…˜ìœ¼ë¡œë„ ë¶ˆë¦°ë‹¤.

í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ì´ëŸ° íŠ¹ì§• ë•Œë¬¸ì— ì»¬ë ‰ì…˜ì„ ì‚¬ìš©í•  ë•Œ ë‹¤ìŒì²˜ëŸ¼ ì¦‰ì‹œ ì´ˆê¸°í™”í•´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.

```java
Collection<Member> members = new ArrayList<Member>();
```

### ì¸í„°í˜ì´ìŠ¤ì™€ ì»¬ë ‰ì…˜ ë˜í¼

```java
// org.hibernate.collection.internal.PersistentBag
@OneToMany
Collection<Member> collection = new ArrayList<>();

// org.hibernate.collection.internal.PersistentBag
@OneToMany
List<Member> list = new ArrayList<>();

// org.hibernate.collection.internal.PersistentSet
@OneToMany
Set<Member> set = new HashSet<>();

// org.hibernate.collection.internal.PersistentList
@OneToMany @OrderColumn
List<Member> orderColumnList = new ArrayList<>();
```



## 14.1.2 Collection, List

> Collection, List ì¸í„°í˜ì´ìŠ¤ëŠ” ì¤‘ë³µì„ í—ˆìš©í•˜ëŠ” ì»¬ë ‰ì…˜ì´ê³  PersistentBagì„ ë˜í¼ ì»¬ë ‰ì…˜ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. ì´ ì¸í„°í˜ì´ìŠ¤ëŠ” ArrayListë¡œ ì´ˆê¸°í™”í•˜ë©´ ëœë‹¤.
> 

```java
@Entity
public class Parent{
		
		@Id @GeneratedValue
		private Long id;
		
		@OneToMany
		@JoinColumn
		private Collection<CollectionChild> collection = new ArrayList<>();
		
		@OneToMany
		@JoinColumn
		private List<ListChild> list = new ArrayList<>();
		...
}
```

Collection, ListëŠ” ì¤‘ë³µì„ í—ˆìš©í•œë‹¤ê³  ê°€ì •í•˜ë¯€ë¡œ ê°ì²´ë¥¼ ì¶”ê°€í•˜ëŠ” add() ë©”ì„œë“œëŠ” ë‚´ë¶€ì—ì„œ ì–´ë–¤ ë¹„êµë„ í•˜ì§€ ì•Šê³  í•­ìƒ trueë¥¼ ë°˜í™˜í•œë‹¤.

ê°™ì€ ì—”í‹°í‹°ê°€ ìˆëŠ”ì§€ ì°¾ê±°ë‚˜ ì‚­ì œí•  ë•ŒëŠ” equals() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤.

```java
List<Comment> comments = new AarayList<>();
...

// í•­ìƒ true
boolean result = comments.add(data);

// equals() ë¹„êµ
comments.contains(comment); 
comments.remove(comment);
```

Collection, ListëŠ” ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•  ë•Œ ì¤‘ë³µëœ ì—”í‹°í‹°ê°€ ìˆëŠ”ì§€ ë¹„êµí•˜ì§€ ì•Šê³  ë‹¨ìˆœíˆ ì €ì¥ë§Œ í•˜ë©´ ëœë‹¤.

ë”°ë¼ì„œ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•´ë„ ì§€ì—° ë¡œë”©ëœ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•˜ì§€ ì•ŠëŠ”ë‹¤.

## 14.1.3 Set

> Setì€ ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì»¬ë ‰ì…˜ì´ë‹¤. í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” PersistentSetì„ ì»¬ë ‰ì…˜ ë˜í¼ë¡œ ì‚¬ìš©í•œë‹¤. ì´ ì¸í„°í˜ì´ìŠ¤ëŠ” HashSetìœ¼ë¡œ ì´ˆê¸°í™”í•˜ë©´ ëœë‹¤.
> 

```java
@Entity
public class Parent{

		@OneToMany
		@JoinColumn
		private Set<SetChild> set = new HashSet<>();
		...
}
```

HashSetì€ ì¤‘ë³µì„ í—ˆìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ add() ë©”ì„œë“œë¡œ ê°ì²´ë¥¼ ì¶”ê°€í•  ë•Œ ë§ˆë‹¤ equals() ë©”ì„œë“œë¡œ ê°™ì€ ê°ì²´ê°€ ìˆëŠ”ì§€ ë¹„êµí•œë‹¤.

- ê°™ì€ ê°ì²´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€í•˜ê³  trueë¥¼ ë°˜í™˜í•˜ê³ , ê°™ì€ ê°ì²´ê°€ ì´ë¯¸ ìˆì–´ì„œ ì¶”ê°€ì— ì‹¤íŒ¨í•˜ë©´ falseë¥¼ ë°˜í™˜í•œë‹¤.
- ì°¸ê³ ë¡œ HashSetì€ í•´ì‹œ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ë¯€ë¡œ hashCode()ë„ í•¨ê»˜ ì‚¬ìš©í•´ì„œ ë¹„êµí•œë‹¤.

```java
Set<Comment> comments = new HashSet<>();
...

// hashcode + equals ë¹„êµ
boolean result = comments.add(data)
comments.contains(comment);
comments.remove(comment);
```

Setì€ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•  ë•Œ ì¤‘ë³µëœ ì—”í‹°í‹°ê°€ ìˆëŠ”ì§€ ë¹„êµí•´ì•¼ í•œë‹¤. ë”°ë¼ì„œ ì—”í‹°í‹°ë¥¼ ì¶”ê°€í•  ë•Œ ì§€ì—° ë¡œë”©ëœ ì»¬ë ‰ì…˜ì„ ì´ˆê¸°í™”í•œë‹¤.

## 14.1.4 List + @OrderColumn

> List ì¸í„°í˜ì´ìŠ¤ì— @OrderColumnì„ ì¶”ê°€í•˜ë©´ ìˆœì„œê°€ ìˆëŠ” íŠ¹ìˆ˜í•œ ì»¬ë ‰ì…˜ìœ¼ë¡œ ì¸ì‹í•œë‹¤.
> 
- ìˆœì„œê°€ ìˆë‹¤ëŠ” ì˜ë¯¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ìˆœì„œ ê°’ì„ ì €ì¥í•´ì„œ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•œë‹¤ëŠ” ì˜ë¯¸ë‹¤.
    
    ```java
    @Entity
    public class Board{
    		
    		@Id @GeneratedValue
    		private Long id;
    		
    		private String title;
    		private String content;
    		
    		@OneToMany(mappedBy = "board")
    		@OrderColumn(name = "POSITION")
    		private List<Comment> comments = new ArrayList<>();
    		...
    }
    
    @Entity
    public class Comment{
    		
    		@Id @GeneratedValue
    		private Long id;
    		
    		private String comment;
    		
    		@ManyToOne
    		@JoinColumn(name = "BOARD_ID")
    		prvate Board board;
    		...
    }
    ```
    
- í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” ë‚´ë¶€ ì»¬ë ‰ì…˜ì¸ PersistentListë¥¼ ì‚¬ìš©í•œë‹¤.

Board.commentsì— List ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  @OrderColumnì„ ì¶”ê°€í–ˆë‹¤.

- ë”°ë¼ì„œ Board.commentsëŠ” ìˆœì„œê°€ ìˆëŠ” ì»¬ë ‰ì…˜ìœ¼ë¡œ ì¸ì‹ëœë‹¤.

ìë°”ê°€ ì œê³µí•˜ëŠ” List ì»¬ë ‰ì…˜ì€ ë‚´ë¶€ì— ìœ„ì¹˜ ê°’ì„ ê°€ì§€ê³  ìˆë‹¤.

- ë”°ë¼ì„œ ë‹¤ìŒ ì½”ë“œì²˜ëŸ¼ Listì˜ ìœ„ì¹˜ ê°’ì„ í™œìš©í•  ìˆ˜ ìˆë‹¤.

```java
list.add(1, data);
list.get(10);
```

ìˆœì„œê°€ ìˆëŠ” ì»¬ë ‰ì…˜ì€ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆœì„œ ê°’ë„ í•¨ê»˜ ê´€ë¦¬í•œë‹¤.

ì—¬ê¸°ì„œëŠ” @OrderColumnì˜ name ì†ì„±ì— POSITIONì´ë¼ëŠ” ê°’ì„ ì£¼ì—ˆë‹¤.

JPAëŠ” Listì˜ ìœ„ì¹˜ ê°’ì„ í…Œì´ë¸”ì˜ POSITION ì»¬ëŸ¼ì— ë³´ê´€í•œë‹¤.

ê·¸ëŸ°ë° Board.comments ì»¬ë ‰ì…˜ì€ Board ì—”í‹°í‹°ì— ìˆì§€ë§Œ í…Œì´ë¸”ì˜ ì¼ëŒ€ë‹¤ ê´€ê³„ì˜ íŠ¹ì„±ìƒ ìœ„ì¹˜ ê°’ì€ ë‹¤ ìª½ì— ì €ì¥í•´ì•¼ í•œë‹¤.

- ë”°ë¼ì„œ ì‹¤ì œ POSITION ì»¬ëŸ¼ì€ COMMENT í…Œì´ë¸”ì— ë§¤í•‘ëœë‹¤.



```java
Board board = new Board("ì œëª©1", "ë‚´ìš©1");
em.persist(board);

Comment comment1 = new Comment("ëŒ“ê¸€1");
comment1.setBoard(board);
board.getComments().add(comment1); // position 0
em.persist(comment1);

Comment comment2 = new Comment("ëŒ“ê¸€2");
comment2.setBoard(board);
board.getComments().add(comment2); // position 1
em.persist(comment2);

...
```

@OrderColumnì„ ì‚¬ìš©í•´ì„œ Listì˜ ìœ„ì¹˜ ê°’ì„ ë³´ê´€í•˜ë©´ í¸ë¦¬í•  ê²ƒ ê°™ì§€ë§Œ ë‹¤ìŒì—ì„œ ì„¤ëª…í•˜ëŠ” ê²ƒì²˜ëŸ¼ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ê¸°ì—ëŠ” ë‹¨ì ì´ ë§ë‹¤.

- ë”°ë¼ì„œ @Ordercolumnì„ ë§¤í•‘í•˜ì§€ ë§ê³  ê°œë°œìê°€ ì§ì ‘ POSITION ê°’ì„ ê´€ë¦¬í•˜ê±°ë‚˜ ë‹¤ìŒì— ì„¤ëª…í•˜ëŠ” @OrderByë¥¼ ì‚¬ìš©í•˜ê¸¸ ê¶Œì¥í•œë‹¤.

### @OrderColumnì˜ ë‹¨ì 

> OrderColumnì€ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì ë“¤ ë•Œë¬¸ì— ì‹¤ë¬´ì—ì„œ ì˜ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
> 
- @OrderColumnì„ Board ì—”í‹°í‹°ì—ì„œ ë§¤í•‘í•˜ë¯€ë¡œ CommentëŠ” POSITIONì˜ ê°’ì„ ì•Œ ìˆ˜ ì—†ë‹¤.
    - ê·¸ë˜ì„œ Commentë¥¼ INSERTí•  ë•Œ, POSITION ê°’ì´ ì €ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤.
    - POSITIONì€ Board.commentsì˜ ìœ„ì¹˜ ê°’ì´ë¯€ë¡œ, ì´ ê°’ì„ ì‚¬ìš©í•´ì„œ POSITIONì˜ ê°’ì„ UPDATEí•˜ëŠ” SQLì´ ì¶”ê°€ë¡œ ë°œìƒí•œë‹¤.
- Listë¥¼ ë³€ê²½í•˜ë©´ ì—°ê´€ëœ ë§ì€ ìœ„ì¹˜ ê°’ì„ ë³€ê²½í•´ì•¼ í•œë‹¤.
    - ì˜ˆë¥¼ ë“¤ì–´ ëŒ“ê¸€2ë¥¼ ì‚­ì œí•˜ë©´ ëŒ“ê¸€3, ëŒ“ê¸€4ì˜ POSITION ê°’ì„ ê°ê° í•˜ë‚˜ì”© ì¤„ì´ëŠ” UPDATE SQLì´ ì¶”ê°€ë¡œ ë°œìƒí•œë‹¤.
- ì¤‘ê°„ì— POSITION ê°’ì´ ì—†ìœ¼ë©´ ì¡°íšŒí•œ Listì—ëŠ” nullì´ ë³´ê´€ëœë‹¤.
    - ì˜ˆë¥¼ ë“¤ì–´ ëŒ“ê¸€2ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°•ì œë¡œ ì‚­ì œí•˜ê³  ë‹¤ë¥¸ ëŒ“ê¸€ë“¤ì˜ POSITION ê°’ì„ ìˆ˜ì •í•˜ì§€ì•Šìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ì˜ POSITION ê°’ì€ [0, 2, 3]ì´ ë˜ì–´ì„œ ì¤‘ê°„ì— 1 ê°’ì´ ì—†ë‹¤.
    - ì´ ê²½ìš° Listë¥¼ ì¡°íšŒí•˜ë©´ 1ë²ˆ ìœ„ì¹˜ì— null ê°’ì´ ë³´ê´€ëœë‹¤. ë”°ë¼ì„œ ì»¬ë ‰ì…˜ì„ ìˆœíšŒí•  ë•Œ NullPointerExceptionì´ ë°œìƒí•œë‹¤.

## 14.1.5 @OrderBy

> @OrderColumnì´ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆœì„œìš© ì»¬ëŸ¼ì„ ë§¤í•‘í•´ì„œ ê´€ë¦¬í–ˆë‹¤ë©´ @OrderByëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ORDER BYì ˆì„ ì‚¬ìš©í•´ì„œ ì»¬ë ‰ì…˜ì„ ì •ë ¬í•œë‹¤.
> 
- ë”°ë¼ì„œ ìˆœì„œìš© ì»¬ëŸ¼ì„ ë§¤í•‘í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.
- ê·¸ë¦¬ê³  @OrderByëŠ” ëª¨ë“  ì»¬ë ‰ì…˜ì— ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```java
@Entity
public class Team{

		@Id @GeneratedValue
		private Long id;
		private String name;
		
		@OneToMany(mappedBy = "team")
		@OrderBy("username desc, id asc")
		private Set<Member> members = new HashSet<>();
		...
}

@Entity
public class Member{

		@Id @GeneratedValue
		private Long id;
		
		@Column(name = "MEMBER_NAME")
		private String username;
		
		@ManyToOne
		private Team team;
		...
}
```

Team.membersë¥¼ ë³´ë©´ @OrderByë¥¼ ì ìš©í–ˆë‹¤. 

ê·¸ë¦¬ê³  @OrderByì˜ ê°’ìœ¼ë¡œ username desc, id ascë¥¼ ì‚¬ìš©í•´ì„œ Memberì˜ username í•„ë“œë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ê³  idë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬í–ˆë‹¤.

@OrderByì˜ ê°’ì€ JPQLì˜ order byì ˆ ì²˜ëŸ¼ ì—”í‹°í‹°ì˜ í•„ë“œë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œë‹¤.

```java
Team findteam = em.find(Team.class, team.getId());
findTeam.getMembers().size(); // ì´ˆê¸°í™”

// sql
SELECT M.*
FROM MEMBER M
WHERE M.TEAM_ID=?
ORDER BY M.MEMBER_NAME DESC, M.ID ASC
```

<aside>
ğŸ¤š í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” Setì— @OrderByë¥¼ ì ìš©í•´ì„œ ê²°ê³¼ë¥¼ ì¡°íšŒí•˜ë©´ ìˆœì„œë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ HashSet ëŒ€ì‹ ì— LinkedHashSetì„ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•œë‹¤.

</aside>

# 14.2 @Converter

> ì»¨ë²„í„°ë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ ë³€í™˜í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•  ìˆ˜ ìˆë‹¤.
> 
- ì˜ˆë¥¼ ë“¤ì–´ íšŒì›ì˜ VIP ì—¬ë¶€ë¥¼ ìë°”ì˜ boolean íƒ€ì…ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ê³  í•˜ì. JPAë¥¼ ì‚¬ìš©í•˜ë©´ ìë°”ì˜ boolean íƒ€ì…ì€ ë°©ì–¸ì— ë”°ë¼ ë‹¤ë¥´ì§€ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë  ë•Œ 0 ë˜ëŠ” 1ì¸ ìˆ«ìë¡œ ì €ì¥ëœë‹¤.
- ê·¸ëŸ°ë° ë°ì´í„°ë² ì´ìŠ¤ì— ìˆ«ì ëŒ€ì‹  ë¬¸ì Y ë˜ëŠ” Nìœ¼ë¡œ ì €ì¥í•˜ê³  ì‹¶ë‹¤ë©´ ì»¨ë²„í„°ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
CREATE TABLE MEMBER{

		ID VARCHAR(255) NOT NULL,
		USERNAME VARCHAR(255),
		VIP VARCHAR(1) NOT NULL,
		PRIMARY KEY (ID)
}
```

```java
@Entity
public class Member{

		@Id 
		private String id;
		private String username;
		
		@Convert(converter=BooleanToYNConverter.class)
		private boolean vip;
		
		...
}
```

íšŒì› ì—”í‹°í‹°ì˜ vip í•„ë“œëŠ” boolean íƒ€ì…ì´ë‹¤.

@Converterë¥¼ ì ìš©í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ê¸° ì§ì „ì— BooleanToYNConverter ì»¨ë²„í„°ê°€ ë™ì‘í•˜ë„ë¡ í–ˆë‹¤.

```java
@Converter
public class BooleanToYNConverter 
								implements AttributeConverter<Boolean, String>{

		@Override
		public String convertToDatabaseColumn(Boolean attribute){
				return (attribute != null && attribute) ? "Y" : "N";
		}								
		
		@Override
		public Boolean convertToEntityAttribute(String dbData){
				return "Y".equals(dbData);
		}
}
```

ì»¨ë²„í„° í´ë˜ìŠ¤ëŠ” @Converter ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ê³  AttributeConverter ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼ í•œë‹¤.

ê·¸ë¦¬ê³  ì œë„¤ë¦­ì— í˜„ì¬ íƒ€ì…ê³¼ ë³€í™˜í•  íƒ€ì…ì„ ì§€ì •í•´ì•¼ í•œë‹¤.

- ì—¬ê¸°ì„œëŠ” <Boolean, String>ì„ ì§€ì •í•´ì„œ Boolean íƒ€ì…ì„ String íƒ€ì…ìœ¼ë¡œ ë³€í™˜í•œë‹¤.

```java
public interface AttributeConverter<X, Y>{
		public Y convertToDatabaseColumn(X attribute);
		public X convertToEntityAttribute(Y dbData);
}
```

- convertToDatabaseColumn() : ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ ì»¬ëŸ¼ì— ì €ì¥í•  ë°ì´í„°ë¡œ ë³€í™˜í•œë‹¤.
- convertToEntityAttribute() : ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•œ ì»¬ëŸ¼ ë°ì´í„°ë¥¼ ì—”í‹°í‹°ì˜ ë°ì´í„°ë¡œ ë³€í™˜í•œë‹¤.

ì»¨ë²„í„°ëŠ” ë‹¤ìŒ ì²˜ëŸ¼ í´ë˜ìŠ¤ ë ˆë²¨ì—ë„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

ë‹¨, ì´ ë•ŒëŠ” attributeName ì†ì„±ì„ ì‚¬ìš©í•´ì„œ ì–´ë–¤ í•„ë“œì— ì»¨ë²„í„°ë¥¼ ì ìš©í• ì§€ ëª…ì‹œí•´ì•¼ í•œë‹¤.

```java
@Entity
@Convert(converter=BooleanToYNConverter.class, attributeName = "vip")
public class Member{
	...
}
```

## 14.2.1 ê¸€ë¡œë²Œ ì„¤ì •

ëª¨ë“  Boolean íƒ€ì…ì— ì»¨ë²„í„°ë¥¼ ì ìš©í•˜ë ¤ë©´ @Converter(autoApply = true) ì˜µì…˜ì„ ì ìš©í•˜ë©´ ëœë‹¤.

```java
@Converter(autoApply = true)
public class BooleanToYNConverter implements
		AttributeConverter<Boolean, String>{
		
		@Override
		public String convertToDatabaseColumn(Boolean attribute){
				return (attribute != null && attribute) ? "Y" : "N";
		}								
		
		@Override
		public Boolean convertToEntityAttribute(String dbData){
				return "Y".equals(dbData);
		}
}
```

ì´ë ‡ê²Œ ê¸€ë¡œë²Œ ì„¤ì •ì„ í•˜ë©´ @Convertë¥¼ ì§€ì •í•˜ì§€ ì•Šì•„ë„ ëª¨ë“  Boolean íƒ€ì…ì— ìë™ìœ¼ë¡œ ì»¨ë²„í„°ê°€ ì ìš©ëœë‹¤.

```java
@Entity
public class Member{

		@Id 
		private String id;
		private String username;
		
		private boolean vip;
		
		...
}
```



# 14.3 ë¦¬ìŠ¤ë„ˆ

ëª¨ë“  ì—”í‹°í‹°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì–¸ì œ ì–´ë–¤ ì‚¬ìš©ìê°€ ì‚­ì œë¥¼ ìš”ì²­í–ˆëŠ”ì§€ ëª¨ë‘ ë¡œê·¸ë¡œ ë‚¨ê²¨ì•¼ í•˜ëŠ” ìš”êµ¬ì‚¬í•­ì´ ìˆë‹¤ê³  ê°€ì •í•˜ì. 

ì´ë•Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚­ì œ ë¡œì§ì„ í•˜ë‚˜ì”© ì°¾ì•„ì„œ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒì€ ë„ˆë¬´ ë¹„íš¨ìœ¨ì ì´ë‹¤.

JPA ë¦¬ìŠ¤ë„ˆ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ì— ë”°ë¥¸ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

## 14.3.1 ì´ë²¤íŠ¸ ì¢…ë¥˜

> ì´ë²¤íŠ¸ì˜ ì¢…ë¥˜ì™€ ë°œìƒ ì‹œì ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.
> 



1. PostLoad : ì—”í‹°í‹°ê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¡°íšŒëœ ì§í›„ ë˜ëŠ” refreshë¥¼ í˜¸ì¶œí•œ í›„(2ì°¨ ìºì‹œì— ì €ì¥ë˜ì–´ ìˆì–´ë„ í˜¸ì¶œëœë‹¤.)
2. PrePersist : persist() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê´€ë¦¬í•˜ê¸° ì§ì „ì— í˜¸ì¶œëœë‹¤.
    - ì‹ë³„ì ìƒì„± ì „ëµì„ ì‚¬ìš©í•œ ê²½ìš° ì—”í‹°í‹°ì— ì‹ë³„ìëŠ” ì•„ì§ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ mergeí•  ë•Œë„ ìˆ˜í–‰ëœë‹¤.
3. PreUpdate : flushë‚˜ commitì„ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆ˜ì •í•˜ê¸° ì§ì „ì— í˜¸ì¶œëœë‹¤.
4. PreRemove : remove() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí•˜ê¸° ì§ì „ì— í˜¸ì¶œëœë‹¤.
    - ë˜í•œ ì‚­ì œ ëª…ë ¹ì–´ë¡œ ì˜ì†ì„± ì „ì´ê°€ ì¼ì–´ë‚  ë•Œë„ í˜¸ì¶œëœë‹¤.
    - orphanRemovalì— ëŒ€í•´ì„œëŠ” flushë‚˜ commit ì‹œì— í˜¸ì¶œëœë‹¤.
5. PostPersist : flushë‚˜ commitì„ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œ ì§í›„ì— í˜¸ì¶œëœë‹¤.
    - ì‹ë³„ìê°€ í•­ìƒ ì¡´ì¬í•œë‹¤.
    - ì°¸ê³ ë¡œ ì‹ë³„ì ìƒì„± ì „ëµì´ IDENTITYë©´ ì‹ë³„ìë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ persist()ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì €ì¥í•˜ë¯€ë¡œ ì´ë•ŒëŠ” persist()ë¥¼ í˜¸ì¶œí•œ ì§í›„ì— ë°”ë¡œ PostPersist()ê°€ í˜¸ì¶œëœë‹¤.
- PostUpdate : flushë‚˜ commitì„ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆ˜ì •í•œ ì§í›„ì— í˜¸ì¶œëœë‹¤.
- PostRemove : flushë‚˜ commitì„ í˜¸ì¶œí•´ì„œ ì—”í‹°í‹°ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì‚­ì œí•œ ì§í›„ì— í˜¸ì¶œëœë‹¤.

## 14.3.2 ì´ë²¤íŠ¸ ì ìš© ìœ„ì¹˜

> ì´ë²¤íŠ¸ëŠ” ì—”í‹°í‹°ì—ì„œ ì§ì ‘ ë°›ê±°ë‚˜ ë³„ë„ì˜ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•´ì„œ ë°›ì„ ìˆ˜ ìˆë‹¤.
> 
1. ì—”í‹°í‹°ì— ì§ì ‘ ì ìš©
2. ë³„ë„ì˜ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
3. ê¸°ë³¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©

### ì—”í‹°í‹°ì— ì§ì ‘ ì ìš©

```java
@Entity
public class Duck{
		@Id @GeneratedValue
		public Long id;
		
		private String name;
		
		@PrePersist
		public void prePersist() {
				// prePersist
		}
		
		@PostPersist
		public void postPersist() {
				// post Persist
		}
		
		@PostLoad
		publc void postLoad() {
				// post Load
		}
		
		@PreRemove
		public void preRemove(){
				// pre Remove
		}
		
		@PostRemove
		public void postRemove(){
				// post remove
		}
		
}
```

ì—”í‹°í‹°ì— ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ì§€ì •í•œ ë©”ì„œë“œê°€ ì‹¤í–‰ëœë‹¤.

### ë³„ë„ì˜ ë¦¬ìŠ¤ë„ˆ ë“±ë¡

```java
@Entity
@EntityListeners(DuckListner.class)
public class Duck{
		...
}

public class DuckListener{
		
		@PrePersist
		// íŠ¹ì • íƒ€ì…ì´ í™•ì‹¤í•˜ë©´ íŠ¹ì • íƒ€ì…ì„ ë°›ì„ ìˆ˜ ìˆë‹¤.
		private void prePersist(Object obj){
				System.out.println(obj);
		}
		
		@PostPersist
		private void postPersist(Object obj){
				System.out.println(obj);
		}
}
```

ë¦¬ìŠ¤ë„ˆëŠ” ëŒ€ìƒ ì—”í‹°í‹°ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ìˆ˜ ìˆë‹¤. ë°˜í™˜ íƒ€ì…ì€ voidë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.

### ê¸°ë³¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©

> ëª¨ë“  ì—”í‹°í‹°ì˜ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ë ¤ë©´ META-INF/orm.xmlì— ê¸°ë³¸ ë¦¬ìŠ¤í„°ë¡œ ë“±ë¡í•˜ë©´ ëœë‹¤.
> 



ì—¬ëŸ¬ ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡í•˜ì˜€ì„ ê²½ìš° ì´ë²¤íŠ¸ í˜¸ì¶œ ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. ê¸°ë³¸ ë¦¬ìŠ¤ë„ˆ
2. ë¶€ëª¨ í´ë˜ìŠ¤ ë¦¬ìŠ¤ë„ˆ
3. ë¦¬ìŠ¤ë„ˆ
4. ì—”í‹°í‹°

### ë” ì„¸ë°€í•œ ì„¤ì •

> ë” ì„¸ë°€í•œ ì„¤ì •ì„ ìœ„í•œ ì–´ë…¸í…Œì´ì…˜ë„ ìˆë‹¤.
> 
- javax.persistence.ExcludeDefaultListeners : ê¸°ë³¸ ë¦¬ìŠ¤ë„ˆ ë¬´ì‹œ
- javax.persistence.ExcludeSuperclassListerners : ìƒìœ„ í´ë˜ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë¬´ì‹œ

```java
@Entity
@EntityListerners(DuckListener.class)
@ExcludeDefaultListeners
@ExcludeSuperclassListerners
public class Duck extends BaseEntity{
		...
}
```

ì´ë²¤íŠ¸ë¥¼ ì˜ í™œìš©í•˜ë©´ ëŒ€ë¶€ë¶„ì˜ ì—”í‹°í‹°ì— ê³µí†µìœ¼ë¡œ ì ìš©í•˜ëŠ” ë“±ë¡ ì¼ì, ìˆ˜ì • ì¼ì ì²˜ë¦¬ì™€ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ëˆ„ê°€ ë“±ë¡í•˜ê³  ìˆ˜ì •í–ˆëŠ”ì§€ì— ëŒ€í•œ ê¸°ë¡ì„ ë¦¬ìŠ¤ë„ˆ í•˜ë‚˜ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

# 14.4 ì—”í‹°í‹° ê·¸ë˜í”„

> ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ë ¤ë©´ ë‹¤ìŒì²˜ëŸ¼ ê¸€ë¡œë²Œ fetch ì˜µì…˜ì„ FetchType.EAGERë¡œ ì„¤ì •í•œë‹¤.
> 

```java
@Entity
class Order {
		@ManyToOne(fetch=FetchType.EAGER)
		Member member;
		...
}
```

ë˜ëŠ” ë‹¤ìŒì²˜ëŸ¼ JPQLì—ì„œ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
select o from Order o join fetch o.member
```

ê¸€ë¡œë²Œ fetch ì˜µì…˜ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì— ì˜í–¥ì„ ì£¼ê³  ë³€ê²½í•  ìˆ˜ ì—†ëŠ” ë‹¨ì ì´ ìˆë‹¤.

ê·¸ë˜ì„œ ì¼ë°˜ì ìœ¼ë¡œ ê¸€ë¡œë²Œ fetch ì˜µì…˜ì€ FetchType.LAZYë¥¼ ì‚¬ìš©í•˜ê³ , ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•  í•„ìš”ê°€ ìˆìœ¼ë©´ JPQLì˜ í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•œë‹¤.

ê·¸ëŸ°ë° í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ê°™ì€ JPQLì„ ì¤‘ë³µí•´ì„œ ì‘ì„±í•˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤.

- ì˜ˆë¥¼ ë“¤ì–´ ì£¼ë¬¸ ìƒíƒœë¥¼ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì£¼ë¬¸ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” JPQLì„ ì‘ì„±í•´ë³´ì.

```java
select o 
from Order o
where o.status = ?
```

ì£¼ë¬¸ê³¼ íšŒì›ì„ í•¨ê»˜ ì¡°íšŒí•  í•„ìš”ê°€ ìˆì–´ì„œ ë‹¤ìŒ JPQLì„ ìƒˆë¡œ ì¶”ê°€í–ˆë‹¤.

```java
select o 
from Order o join fetch o.member
where o.status = ?
```

ì£¼ë¬¸ê³¼ ì£¼ë¬¸ ìƒí’ˆì„ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•´ì„œ ë‹¤ìŒ JPQLì„ ìƒˆë¡œ ì¶”ê°€í–ˆë‹¤.

```java
select o 
from Order o join fetch o.orderItems
where o.status = ?
```

3ê°€ì§€ JPQL ëª¨ë‘ ì£¼ë¬¸ì„ ì¡°íšŒí•˜ëŠ” ê°™ì€ JPQLì´ì§€ë§Œ í•¨ê»˜ ì¡°íšŒí•  ì—”í‹°í‹°ì— ë”°ë¼ì„œ ë‹¤ë¥¸ JPQLì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

ì´ê²ƒì€ JPQLì´ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ë¿ë§Œ ì•„ë‹ˆë¼ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê²Œ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ë„ ì œê³µí•˜ê¸° ë•Œë¬¸ì¸ë°, ê²°êµ­ JPQLì´ ë‘ ê°€ì§€ ì—­í• ì„ ëª¨ë‘ ìˆ˜í–‰í•´ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë‹¤.

JPA 2.1ì— ì¶”ê°€ëœ ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ì‹œì ì— í•¨ê»˜ ì¡°íšŒí•  ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì„ íƒí•  ìˆ˜ ìˆë‹¤.

- ë”°ë¼ì„œ JPQLì€ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ë§Œ ìˆ˜í–‰í•˜ë©´ ë˜ê³  ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì€ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì„ ì ìš©í•˜ë©´ ë‹¤ìŒ JPQLë§Œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
select o 
from Order o
where o.status = ?
```

ì—”í‹°í‹° ê·¸ë˜í”„ ê¸°ëŠ¥ì€ ì—”í‹°í‹° ì¡°íšŒì‹œì ì— ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ í•¨ê»˜ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

ì—”í‹°í‹° ê·¸ë˜í”„ëŠ” ì •ì ìœ¼ë¡œ ì •ì˜í•˜ëŠ” Named ì—”í‹°í‹° ê·¸ë˜í”„ì™€ ë™ì ìœ¼ë¡œ ì •ì˜í•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ê°€ ìˆë‹¤.

### ì‚¬ìš©í•  ì—”í‹°í‹° ëª¨ë¸



## 14.4.1 Named ì—”í‹°í‹° ê·¸ë˜í”„

> ì£¼ë¬¸ì„ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ íšŒì›ë„ í•¨ê²Œ ì¡°íšŒí•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•´ë³´ì.
> 

```java
@NamedEntityGraph(name = "Order.withMember", attributeNodes = {
		@NamedAttributeNode("member")
})
@Entity
@Table(name = "ORDERS")
public class Order{
		
		@Id @GeneratedValue
		@Column(name = "ORDER_ID")
		private Long id;
		
		@ManyToOne(fetch = FetchType.LAZY, optional = false)
		@JoinColumn(name = "MEMBER_ID")
		private Member member;
}
```

Named ì—”í‹°í‹° ê·¸ë˜í”„ëŠ” @NamedEntityGraphë¡œ ì •ì˜í•œë‹¤.

- name : ì—”í‹°í‹° ê·¸ë˜í”„ì˜ ì´ë¦„ì„ ì •ì˜í•œë‹¤.
- attributeNodes : í•¨ê»˜ ì¡°íšŒí•  ì†ì„±ì„ ì„ íƒí•œë‹¤. ì´ë•Œ @NamedAttributeNodeë¥¼ ì‚¬ìš©í•˜ê³  ê·¸ ê°’ìœ¼ë¡œ í•¨ê»˜ ì¡°íšŒí•  ì†ì„±ì„ ì„ íƒí•˜ë©´ ëœë‹¤.

Order.memberê°€ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì§€ë§Œ, ì—”í‹°í‹° ê·¸ë˜í”„ì—ì„œ í•¨ê»˜ ì¡°íšŒí•  ì†ì„±ìœ¼ë¡œ memberë¥¼ ì„ íƒí–ˆìœ¼ë¯€ë¡œ ì´ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ Orderë¥¼ ì¡°íšŒí•  ë•Œ ì—°ê´€ëœ memberë„ í•¨ê»˜ ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.

- ë‘˜ ì´ìƒ ì¡°íšŒí•  ë•ŒëŠ” @NamedEtityGraphsë¥¼ ì‚¬ìš©í•œë‹¤.

## 14.4.2 em.find()ì—ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ ì‚¬ìš©

```java
EntityGraph graph = em.getEntityGraph("Order.withMember");

Map hints = new HashMap();
hints.put("javax.persistence.fetchgraph", graph);

Order order = em.find(Order.class, orderId, hints);
```

Named ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì •ì˜í•œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ em.getEntityGraph(â€Order.withMemberâ€)ë¥¼ í†µí•´ì„œ ì°¾ì•„ì˜¤ë©´ ëœë‹¤.

ì—”í‹°í‹° ê·¸ë˜í”„ëŠ” JPAì˜ íŒíŠ¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì„œ ë™ì‘í•˜ëŠ”ë° íŒíŠ¸ì˜ í‚¤ë¡œ javax.persistence.fetchgraphë¥¼ ì‚¬ìš©í•˜ê³  íŒíŠ¸ì˜ ê°’ìœ¼ë¡œ ì°¾ì•„ì˜¨ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

ì‹¤í–‰ëœ ì—”SQLì„ ë³´ë©´ memberë„ í•¨ê»˜ ì¡°íšŒí•œë‹¤.

```java
select o.*, m.*
from ORDERS o inner join Member m
on o.MEMBER_ID = m.MEMBER_ID
where o.ORDER_ID = ?
```

## 14.4.3 subgraph

ì´ë²ˆì—ëŠ” Order â†’ OrderItem â†’ Itemê¹Œì§€ í•¨ê»˜ ì¡°íšŒí•´ë³´ì.

Order â†’ OrderItemì€ Orderê°€ ê´€ë¦¬í•˜ëŠ” í•„ë“œì§€ë§Œ OrderItem â†’ Itemì€ Orderê°€ ê´€ë¦¬í•˜ëŠ” í•„ë“œê°€ ì•„ë‹ˆë‹¤.

```java
@NamedEntityGraph(name = "Order.withAll", attributeNodes = {
		@NamedAttributeNode("member"),
		@NamedAttributeNode(value = "orderItems", subgraph = "OrderItems")
},
	subgraphs = @NamedSubgraph(name = "orderItems", attributeNodes = {
			@NamedAttributeNode("item")
	})	
)
@Entity
@Table(name = "ORDERS")
public class Order{
		
		@Id @GeneratedValue
		@Column(name = "ORDER_ID")
		private Long id;
		
		@ManyToOne(fetch = FetchType.LAZY, optional = false)
		@JoinColumn(name = "MEMBER_ID")
		private Member member;
		
		@OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
		private List<OrderItem> orderItems = new ArrayList<>();
}
```

ì´ ì—”í‹°í‹° ê·¸ë˜í”„ëŠ” Order â†’ Member, Order â†’ OrderItem,  OrderItem â†’ Itemì˜ ê°ì²´ ê·¸ë˜í”„ë¥¼ í•¨ê»˜ ì¡°íšŒí•œë‹¤.

ì´ë•Œ OrderItem â†’ Itemì€ Orderì˜ ê°ì²´ ê·¸ë˜í”„ê°€ ì•„ë‹ˆë¯€ë¡œ subgraphs ì†ì„±ìœ¼ë¡œ ì •ì˜í•´ì•¼ í•œë‹¤.

ì´ ì†ì„±ì€ @NamedSubgraphë¥¼ ì‚¬ìš©í•´ì„œ ì„œë¸Œ ê·¸ë˜í”„ë¥¼ ì •ì˜í•œë‹¤.

- ì—¬ê¸°ì„œëŠ” OrderItemsë¼ëŠ” ì´ë¦„ì˜ ì„œë¸Œ ê·¸ë˜í”„ê°€ itemì„ í•¨ê»˜ ì¡°íšŒí•˜ë„ë¡ ì •ì˜í–ˆë‹¤.

```java
EntityGraph graph = em.getEntityGraph("Order.withAll");

Map hints = new HashMap();
hints.put("javax.persistence.fetchgraph", graph);

Order order = em.find(Order.class, orderId, hints);
```

## 14.4.4 JPQLì—ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ ì‚¬ìš©

> JPQLì—ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ em.find()ì™€ ë™ì¼í•˜ê²Œ íŒíŠ¸ë§Œ ì¶”ê°€í•˜ë©´ ëœë‹¤.
> 

```java
List<Order> resultList = 
		em.createQuery("select o from Order o where o.id = :orderId", Order.class)
				.setParameter("orderId", orderId)
				.setHint("javax.persistence.fetchgraph", 
										em.getEntityGraph("Order.withAll"))
				.getResultList();
```

ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ í•¨ê»˜ ì¡°íšŒí•œë‹¤.

<aside>
ğŸ¤š em.find()ì—ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ í•˜ì´ë²„ë„¤ì´íŠ¸ëŠ” í•„ìˆ˜ ê´€ê³„ë¥¼ ê³ ë ¤í•´ì„œ SQL ë‚´ë¶€ ì¡°ì¸ì„ ì‚¬ìš©í•˜ì§€ë§Œ JPQLì—ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” í•­ìƒ SQL ì™¸ë¶€ ì¡°ì¸ì„ ì‚¬ìš©í•œë‹¤. ë§Œì•½ SQL ë‚´ë¶€ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë‚´ë¶€ ì¡°ì¸ì„ ëª…ì‹œí•´ì•¼ í•œë‹¤.
select o from Order o join fetch o.member where [o.id](http://o.id) = :orderId

</aside>

## 14.4.5 ë™ì  ì—”í‹°í‹° ê·¸ë˜í”„

> ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±í•˜ë ¤ë©´ createEntityGraph() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ëœë‹¤.
> 

```java
public <T> EntityGraph<T> createEntityGraph(Class<T> rootType);
```

- ì²˜ìŒì— ì‚¬ìš©í•œ Named ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë™ì ìœ¼ë¡œ êµ¬ì„±í•´ë³´ì.

```java
EntityGraph<Order> graph = em.createEntityGraph(Order.class);
graph.addAttributeNodes("member";

Map hints = new HashMap();
hints.put("javax.persistence.fetchgraph", graph);

Order order = em.find(Order.class, orderId, hints);
```

em.createEntityGraph(Order.class)ë¥¼ ì‚¬ìš©í•´ì„œ ë™ì ìœ¼ë¡œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ë§Œë“¤ì—ˆë‹¤.

ê·¸ë¦¬ê³  graph.addAttributeNodes(â€memberâ€)ë¥¼ ì‚¬ìš©í•´ì„œ Order.member ì†ì„± ì—”í‹°í‹° ê·¸ë˜í”„ì— í¬í•¨í–ˆë‹¤.

subgraph ê¸°ëŠ¥ì„ ë™ì ìœ¼ë¡œ êµ¬ì„±í•´ë³´ì.

```java
EntityGraph<Order> graph = em.createEntityGraph(Order.class);
graph.addAttributeNodes("member");
Subgraph<OrderItem> orderItems = graph.addSubgraph("orderItems");
orderItems.addAttributeNodes("item");

Map hints = new HashMap();
hints.put("javax.persistence.fetchgraph", graph);

Order order = em.find(Order.class, orderId, hints);
```

## 14.4.6 ì—”í‹°í‹° ê·¸ë˜í”„ ì •ë¦¬

- ROOTì—ì„œ ì‹œì‘
    
    ì—”í‹°í‹° ê·¸ë˜í”„ëŠ” í•­ìƒ ì¡°íšŒí•˜ëŠ” ì—”í‹°í‹°ì˜ ROOTì—ì„œ ì‹œì‘í•´ì•¼ í•œë‹¤.
    
    ë‹¹ì—°í•œ ì´ì•¼ê¸°ì§€ë§Œ Order ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ”ë° Member ë¶€í„° ì‹œì‘í•˜ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆëœë‹¤.
    
- ì´ë¯¸ ë¡œë”©ëœ ì—”í‹°í‹°
    
    ë‹¤ìŒì²˜ëŸ¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì´ë¯¸ ë¡œë”©ë˜ì–´ ìˆìœ¼ë©´ ì—”í‹°í‹° ê·¸ë˜í”„ê°€ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤. (ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ í”„ë¡ì‹œì—ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ê°€ ì ìš©ëœë‹¤.)
    
    ```java
    Order order1 = em.find(Order.class, orderId); //ì´ë¯¸ ì¡°íšŒ
    hints.put("javax.persistence.fetchgraph"
    							, em.createEntityGraph(Order.class););
    Order order2 = em.find(Order.class, orderId, hints);
    ```
    
    ì´ ê²½ìš° ì¡°íšŒëœ order2ì—ëŠ” ì—”í‹°í‹° ê·¸ë˜í”„ê°€ ì ìš©ë˜ì§€ ì•Šê³  ì²˜ìŒ ì¡°íšŒí•œ order1ê³¼ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ê°€ ë°˜í™˜ëœë‹¤.
    
- fetchgraph, loadgraphì˜ ì°¨ì´
    
    ì˜ˆì œì—ì„œ javax.persistence.fetchgraph íŒíŠ¸ë¥¼ ì‚¬ìš©í•´ì„œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì¡°íšŒí–ˆë‹¤.
    
    ì´ê²ƒì€ ì—”í‹°í‹° ê·¸ë˜í”„ì— ì„ íƒí•œ ì†ì„±ë§Œ í•¨ê»˜ ì¡°íšŒí•œë‹¤.
    
    ë°˜ë©´ì— javax.persistence.loadgraph ì†ì„±ì€ ì—”í‹°í‹° ê·¸ë˜í”„ì— ì„ íƒí•œ ì†ì„± ë¿ë§Œ ì•„ë‹ˆë¼ ê¸€ë¡œë²Œ fetch ëª¨ë“œê°€ FetchType.EAGERë¡œ ì„¤ì •ëœ ì—°ê´€ê´€ê³„ë„ í¬í•¨í•´ì„œ í•¨ê»˜ ì¡°íšŒí•œë‹¤.
    

# 14.5 ì •ë¦¬

ì´ë²ˆ ì¥ì—ì„œ í•™ìŠµí•œ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- JPAê°€ ì§€ì›í•˜ëŠ” ì»¬ë ‰ì…˜ì˜ ì¢…ë¥˜ì™€ íŠ¹ì§•ë“¤ì„ ì•Œì•„ë³´ì•˜ë‹¤.
- ì»¨ë²„í„°ë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ ë³€í™˜í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•  ìˆ˜ ìˆë‹¤.
- ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•˜ë©´ ì—”í‹°í‹°ì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- í˜ì¹˜ ì¡°ì¸ì€ ê°ì²´ì§€í–¥ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ ì—”í‹°í‹° ê·¸ë˜í”„ë¥¼ ì‚¬ìš©í•˜ë©´ ê°ì²´ì§€í–¥ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ì›í•˜ëŠ” ê°ì²´ ê·¸ë˜í”„ë¥¼ í•œ ë²ˆì— ì¡°íšŒí•  ìˆ˜ ìˆë‹¤.